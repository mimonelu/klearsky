<script lang="ts" setup>
import { onBeforeUnmount, onMounted, reactive, ref } from "vue"

defineProps<{
  src?: string
  alt?: string
}>()

const state = reactive<{
  hasError: boolean
  hasLoad: boolean
}>({
  hasError: false,
  hasLoad: false,
})

const imageRef = ref<HTMLImageElement>()

onMounted(() => {
  state.hasError = false
  state.hasLoad = false
})

onBeforeUnmount(() => {
  // 画像メモリの明示的解放
  if (imageRef.value) {
    imageRef.value.src = ""
    imageRef.value.removeAttribute("src")
  }
})

function onError () {
  state.hasError = true
}

function onLoad () {
  state.hasLoad = true
}
</script>

<template>
  <img
    v-if="!state.hasError && src"
    ref="imageRef"
    class="lazy-image lazy-image--src"
    decoding="async"
    loading="lazy"
    :src="src"
    :alt="alt ?? ''"
    :data-has-load="state.hasLoad"
    @error="onError"
    @load="onLoad"
  >
  <img
    v-else
    class="lazy-image"
    decoding="async"
    loading="lazy"
    src="/img/void.png"
    :alt="alt ?? ''"
  >
</template>

<style lang="scss" scoped>
.lazy-image {
  background-color: rgb(var(--fg-color), 0.125);
  display: block;
  &[data-has-load="true"] {
    @keyframes fade-in {
      0% { opacity: 0; }
      100% { opacity: 1.0; }
    }
    animation: fade-in 250ms ease-out;
    animation-fill-mode: forwards;
  }

  &--src {
    opacity: 0;
  }
}
</style>
